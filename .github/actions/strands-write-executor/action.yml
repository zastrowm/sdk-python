name: 'Strands Write Executor'
description: 'Execute write GitHub operations from JSONL artifact files during workflow execution'
inputs:
  ref:
    description: 'Ref to push changes to'
    required: true
  issue_id:
    description: 'Issue ID for fallback operations'
    required: false

runs:
  using: 'composite'
  steps:

    # Push code changes before running write commands in case we need to create a pull request
    # Pull requests cannot be created if a branch has no diff with main, so push changes first, then create pr
    - name: Log if ref equals main
      shell: bash
      run: |
        if [ "${{ inputs.ref }}" = "${{ github.event.repository.default_branch }}" ]; then
          echo "ðŸš« Ref is default - skipping push operations to prevent direct commits to default branch"
        else
          echo "âœ… Ref is '${{ inputs.ref }}' - push operations will proceed"
        fi
    
    - name: Download repository state artifact
      if: inputs.ref != github.event.repository.default_branch
      uses: actions/download-artifact@v4
      with:
        name: repository-state
        path: ${{ runner.temp }}
      continue-on-error: true

    - name: Apply Artifact and Push changes
      if: inputs.ref != github.event.repository.default_branch
      shell: bash
      env:
        GITHUB_TOKEN: ${{ github.token }}
      run: |

        if [ -f "$RUNNER_TEMP/repository_state.tar.gz" ]; then
          echo "ðŸ“ Applying repository state"
          mkdir -p "$RUNNER_TEMP/temp_git_repo"
          tar -xzf "$RUNNER_TEMP/repository_state.tar.gz" -C "$RUNNER_TEMP/temp_git_repo"
          rm "$RUNNER_TEMP/repository_state.tar.gz"
          
          echo "ðŸ“ Changing to repository directory"
          ORIGINAL_DIRECTORY=$(pwd)
          cd "$RUNNER_TEMP/temp_git_repo"

          # Configure Git
          git config --local user.name "Strands Agent"
          git config --local user.email "217235299+strands-agent@users.noreply.github.com"
          git config --local core.pager cat
          # We need to overwrite this since this is currently set by the previous readonly workflow artifact
          # Overwrite this value with the current token that allows us to push the commit
          git config --local http."https://github.com/".extraheader "AUTHORIZATION: basic $(echo -n x-access-token:${{ github.token }}| base64)"

          # Fetch the remote repository
          git fetch origin ${{ inputs.ref }}
          
          # Stage and commit any changes first
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“ Changes detected, staging all files"
            git add -A
            echo "ðŸ“ Committing changes"
            git commit -m "Additional changes from write operations" -n
          fi
          
          # Push if there are differences from remote
          if ! git diff --quiet HEAD origin/${{ inputs.ref }}; then
            echo "ðŸ“ Differences from remote:"
            git diff HEAD origin/${{ inputs.ref }}
            echo "ðŸ“¤ Pushing changes to ${{ inputs.ref }}"
            git push --force origin ${{ inputs.ref }}
          else
            echo "ðŸ“­ No changes to push"
          fi
          
          # Change back and clean up
          cd $ORIGINAL_DIRECTORY
          rm -rf "$RUNNER_TEMP/temp_git_repo"
        fi
    
    - name: Download artifact with write operations
      uses: actions/download-artifact@v4
      with:
        name: write-operations
      continue-on-error: true

    - name: Check if write operations artifact exists
      id: check-write-ops
      shell: bash
      run: |
        if [ -f "write_operations.jsonl" ]; then
          echo "âœ… Write operations artifact exists! Continuing to execute commands!"
          cp -r write_operations.jsonl ${{ runner.temp }}
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Write operations artifact does not exist. Stopping execution."
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Checkout repo to temp dir
      if: steps.check-write-ops.outputs.exists == 'true'
      uses: actions/checkout@v5
      with:
        sparse-checkout: |
          .github
      
    - name: Set up Python
      if: steps.check-write-ops.outputs.exists == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install uv
      if: steps.check-write-ops.outputs.exists == 'true'
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
        cache-dependency-glob: ./.github/scripts/python/requirements.txt

    - name: Install dependencies
      if: steps.check-write-ops.outputs.exists == 'true'
      shell: bash
      run: |
        echo "ðŸ“¦ Installing from requirements.txt"
        uv pip install --system -r ./.github/scripts/python/requirements.txt --quiet

    - name: Execute write operations
      if: steps.check-write-ops.outputs.exists == 'true'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ github.token }}
        GITHUB_REPOSITORY: ${{ github.repository }}

        # Strands Env Vars
        STRANDS_TOOL_CONSOLE_MODE: 'enabled'
        BYPASS_TOOL_CONSENT: 'true'
      run: |
        echo "ðŸš€ Strands Write Executor - Processing write operations"
        if [ -n "${{ inputs.issue_id }}" ]; then
          python ./.github/scripts/python/write_executor.py "${{ runner.temp }}/write_operations.jsonl" --issue-id "${{ inputs.issue_id }}"
        else
          python ./.github/scripts/python/write_executor.py "${{ runner.temp }}/write_operations.jsonl"
        fi
